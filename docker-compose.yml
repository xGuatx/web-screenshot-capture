version: '3.8'

# ShotURL v3.0 - Configuration Optimale
# Meilleur rapport qualite/prix: 3GB RAM + 3 CPU
# Performance: ~25s pour 10 requetes Twitch (-50% vs baseline)

services:
  shoturl:
    build:
      context: .
      dockerfile: docker/Dockerfile
    container_name: shoturl-v3
    restart: unless-stopped

    ports:
      - "8000:8000"

    environment:
      # Server
      - HOST=0.0.0.0
      - PORT=8000
      - DEBUG=false

      # Security
      - ALLOW_LOCAL_URLS=false

      # Browser Limits (OPTIMAL: 3GB RAM + 3 CPU)
      - MAX_CONCURRENT_BROWSERS=3
      - MAX_CONCURRENT_SESSIONS=10
      # - MAX_MEMORY_MB=2600  # Info only, pas de limite technique

      # Timeouts (OPTIMISES)
      - BROWSER_TIMEOUT=12
      - PAGE_LOAD_TIMEOUT=7
      - SESSION_TIMEOUT=60
      - CLEANUP_INTERVAL=3

      # Redis Cache (Optionnel)
      - REDIS_ENABLED=false
      - REDIS_HOST=localhost
      - REDIS_PORT=6379
      - REDIS_DB=0
      - REDIS_CACHE_TTL=180
      - REDIS_SMART_CACHE=true

      # Pre-warm (OPTIMAL: 3 contexts)
      - PREWARM_ENABLED=true
      - PREWARM_COUNT=3

      # Logging
      - LOG_LEVEL=INFO

    volumes:
      - ./logs:/app/logs

    security_opt:
      - seccomp:unconfined

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    networks:
      - shoturl-network

    labels:
      - "com.shoturl.version=3.0.0-optimal"
      - "com.shoturl.config=3GB-3CPU-3browsers-3prewarm"
      - "com.shoturl.performance=~25s"

networks:
  shoturl-network:
    driver: bridge

# Configuration VM Recommandee (VirtualBox)
# VBoxManage modifyvm "shoturl" --memory 3072 --cpus 3
#
# Performance attendue:
# - 10 requetes simultanees: ~25s
# - Gain vs baseline: -50%
# - Success rate: 100%
# - Cout: ~7/mois
# - Ratio perf/prix: 3.57s/ (excellent)
